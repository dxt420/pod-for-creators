{% extends "bl/base.html" %}

{% block content %}
  
<div id="content" class="flex">
    <!-- ############ Main START-->
    <div>
        <div class="page-hero page-container" id="page-hero">
            <div class="padding d-flex">
                <div class="col-sm-12">
                    <div class="card">
                        <div class="b-b">
                            <div class="nav-active-border b-success top">
                                <ul class="nav" id="myTab" role="tablist">
                                    <li class="nav-item"><a class="nav-link active" id="home-tab"
                                            data-toggle="tab" href="#home4" role="tab" aria-controls="home"
                                            aria-selected="true">Upload</a></li>
                                    <li class="nav-item"><a class="nav-link" id="profile-tab" data-toggle="tab"
                                            href="#profile4" role="tab" aria-controls="profile"
                                            aria-selected="false">Profile</a></li>
                                    <li class="nav-item"><a class="nav-link" id="contact-tab" data-toggle="tab"
                                            href="#contact4" role="tab" aria-controls="contact"
                                            aria-selected="false">Contact</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="tab-content p-3">
                            <div class="tab-pane fade show active" id="home4" role="tabpanel"
                                aria-labelledby="home-tab">
                                <div class="padding">

                                    <form action="#" method="POST" id="my-awesome-dropzone"
                                        class="dropzone white b-a b-3x b-dashed b-primary p-a rounded p-5 text-center"
                                        data-plugin="dropzone" data-option="#">

                                        {% csrf_token %}
                                        <div class="dz-message">
                                            <h4 class="my-4">Drag and drop your tracks here</h4><span
                                                class="text-muted d-block mb-4">(Recommended files are
                                                <strong>.mp3, .m4a, .wav .flac, .alac or .aiff</strong> for best
                                                audio experiences uploaded.)</span>
                                        </div>
                                    </form>

                                </div>
                                <div id="former" class="scroll-y mx-3 mb-3 card">

                                </div>



                                <div class="tab-pane fade" id="profile4" role="tabpanel"
                                    aria-labelledby="profile-tab">
                                    <p>Rhoncus non diam cras rutrum pretium adipiscing sagittis, amet, facilisi
                                        porttitor ac odio sed id viverra malesuada ipsum vel metus</p>
                                </div>
                                <div class="tab-pane fade" id="contact4" role="tabpanel"
                                    aria-labelledby="contact-tab">
                                    <p>Duis id in nisl, euismod morbi rutrum varius tempus sollicitudin justo
                                        neque tortor, et diam placerat leo cras lacus sem</p>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

        </div><!-- ############ Main END-->
    </div><!-- ############ Content END-->

{% endblock content %}



{% block scripts %}
  
<script src="/static/bl/libs/dropzone/dist/min/dropzone.min.js"></script>
<script>
    // Dropzone.autoDiscover = false;

    Dropzone.options.myAwesomeDropzone = {
        acceptedFiles: ".mp3,.m4a,.wav,.flac,.alac,.aiff",
        maxFiles: 2,
        // addRemoveLinks: true,
        init:  function () {
            this.on("complete", function (file) {
                // this.removeFile(file); 
                //   alert("Complete."); 
                // console.log(file);
            });


            this.on("addedfile", function (file) {
              
                var formData = new FormData();
             
                formData.append('file', file);
              
                var frm = $('#my-awesome-dropzone');

                var urlx = "{% url 'bl:gettags' %}";
                var urly = urlx.replace('123', file.name);
                var kkk=this;
                $.ajax({
                    type: frm.attr('method'),
                    url: urlx,
                    data: formData,
                    async: true,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        
                        
                        // document.getElementById('cartCounter').setAttribute("data-badge", data.total_items);
                        console.log("pass");
                        console.log(data);


                        // var cover_art = data.image;
                        // var title = data.title;

                        // if (condition) {
                            
                        // }else{

                        // }
                       
                   

                        const toBase64 = file => new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.readAsDataURL(file);
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = error => reject(error);
                        });

                        // var kkk=this;
                     
                            // console.log( toBase64(file));

                            // var songFile = toBase64(file)  + "";


                            toBase64(file).then(function(value) {
                                // console.log(value);
                                // expected output: "Success!"
                                var scratch = '<form id="songFormer" method="post" enctype="multipart/form-data">{% csrf_token %}  <div class="p-4 d-sm-flex no-shrink b-b"><div class="col-4 d-flex"><div class="avatar-upload"> <div class="avatar-edit"> <input name="imageUpload" id="fileHolder" type="text" ><input type="file"  id="imageUpload" accept=".png, .jpg, .jpeg"/> <label for="imageUpload"></label> </div><div class="avatar-preview"> <div id="imagePreview" style="background-image: url(' + data.image + ');"> </div></div></div></div><div class="col-8 px-sm-4 my-3 my-sm-0 flex"> <div class="form-group row"> <div class="col-sm-12"><label>Title</label><input type="text" name="title" class="form-control" value="'+ data.title +'" placeholder="Name" required> <input type="text" name="songFile" value="'+ value +'">  </div></div><div class="form-group"><label>Description (Optional)</label><textarea class="form-control" rows="6" placeholder="hmm.."></textarea></div><a  onclick="addSong()" class="btn btn-primary">Submit</a> </div><div><a href="#" class="btn btn-icon btn-rounded"><i data-feather="mail"></i> </a><a href="#" class="btn btn-icon btn-rounded"><i data-feather="more-vertical"></i></a></div></div></div></form>';
                       
                                document.getElementById("former").innerHTML += scratch;


                                kkk.removeFile(file); 
                                });

                          

                                // this.removeFile(file); 

                        //    console.log(file);
                        

                    },
                    error: function (data) {
                        // $("#MESSAGE-DIV").html("Something went wrong!");
                        console.log("fail");

                    }
                });
                
            });


            // this.on("removedfile", function (file) {
            //     alert("removedfile ");
            //     console.log(file);
            // });




        }
    };




    


    function addSong(){
        // var feat = document.getElementsByClassName('feat'+a);
        // for (var i = 0; i < feat.length; i++) { 
        //     if (feat[i].checked) {
        //         console.log(feat[i].value);
        //         document.getElementById('featured'+a).value = feat[i].value;
                
        //     }else{
        //     }
        //     // feat[i].disabled = false;
        // }
        // var feat = document.querySelector('input[name="rsvp"]:checked').value;
        
        var frm = $('#songFormer');
        var urlx = "{% url 'bl:addsong' %}";
        // var urly = urlx.replace('123',a);
        // frm.submit(function () {
            console.log(frm.serialize());
            $.ajax({
                type: frm.attr('method'),
                url: urlx,
                data: frm.serialize(),
                async:true,
                // processData: false,
                    // contentType: false,
                success: function (data) {
            
               // document.getElementById('cartCounter').setAttribute("data-badge", data.total_items);
               console.log("pass"); 
               frm.hide();
               
               console.log(data); 
                },
                error: function(data) {
                    // $("#MESSAGE-DIV").html("Something went wrong!");
                    console.log("fail"); 
                    console.log(data); 
                
                }
            });
            return false;
        // });
    }

</script>


<script>
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });


    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            var imageData;
          

            reader.onload = (e) => {
                $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
                $('#imagePreview').hide();
                $('#imagePreview').fadeIn(650);
                // $('#fileHolder').val(e.target.result+"");
                // console.log(e.target.result);
                
                imageData = e.target.result+"";
                $('#fileHolder').val(imageData);
            // console.log(imageData);
            }



            reader.readAsDataURL(input.files[0]);


            
            console.log(input.files[0]);
           
        }
    }
    // $("#imageUpload").change(function () {
    //     readURL(this);
    // });


    $(document).on('change', '#imageUpload', function(){
        readURL(this);
    });
</script>
      
{% endblock scripts %}


